// Originally generated by the template in CodeDAO
package kotlinadventofcode.`2023`

import com.github.h0tk3y.betterParse.combinators.*
import com.github.h0tk3y.betterParse.grammar.*
import com.github.h0tk3y.betterParse.lexer.*
import kotlinadventofcode.Day
import java.math.BigInteger
import kotlin.math.abs

class `2023-11` : Day {

    override fun runPartOneNoUI(input: String): String {
        return input.toUniverse().expandBy(2).galaxyDistances.reduce(BigInteger::add).toString()
    }

    override fun runPartTwoNoUI(input: String): String {
        return input.toUniverse().expandBy(1_000_000).galaxyDistances.reduce(BigInteger::add).toString()
    }

    data class Universe(val pixels: List<List<Pixel>>) {
        private val yIndices = pixels.indices
        private val xIndices = pixels[0].indices
        val galaxyDistances by lazy { getDistancesBetweenGalaxies()}

        fun expandBy(factor: Int): Universe {
            val result: List<MutableList<Pixel>> = pixels.map { row ->
                if (row.all { it is Empty }) row.map { Empty(factor.toBigInteger()) }.toMutableList()
                else row.toMutableList()
            }

            for (x in xIndices) {
                if (yIndices.map { result[it][x] }.all { it is Empty }) {
                    yIndices.forEach { result[it][x] = Empty(factor.toBigInteger()) }
                }
            }

            return Universe(result)
        }

        fun getGalaxies(): Set<Coordinate> {
            return xIndices.flatMap { x ->
                yIndices.mapNotNull { y -> if (pixels[y][x] is Galaxy) Coordinate(x, y) else null }
            }.toSet()
        }

        private fun getDistancesBetweenGalaxies(): List<BigInteger> {
            val galaxies = getGalaxies()
            return galaxies
                .flatMap { galaxy ->
                    galaxies.filter { it != galaxy }.map { setOf(galaxy, it) }
                }
                .toSet()
                .map {
                    getHorizontalDistanceBetween(it.first(), it.last()) +
                        getVerticalDistanceBetween(it.first(), it.last())
                }
        }

        private fun getHorizontalDistanceBetween(a: Coordinate, b: Coordinate): BigInteger {
            return getDistanceBetween(a.x, b.x) { x -> pixels[a.y][x].size }
        }

        private fun getVerticalDistanceBetween(a: Coordinate, b: Coordinate): BigInteger {
            return getDistanceBetween(a.y, b.y) { y -> pixels[y][a.x].size }
        }

        private fun getDistanceBetween(a: Int, b: Int, sizeAt: (Int) -> BigInteger): BigInteger {
            val indices = if (a < b - 1) a + 1 until b
            else if (a > b + 1) b + 1 until a
            else return abs(a - b).toBigInteger()

            return indices.map { sizeAt(it) }.reduce(BigInteger::add) + BigInteger.ONE
        }
    }

    data class Coordinate(val x: Int, val y: Int)

    sealed class Pixel {
        abstract val size: BigInteger
    }
    class Empty(override val size: BigInteger) : Pixel()
    object Galaxy : Pixel() {
        override val size: BigInteger = BigInteger.ONE
    }

    companion object {
        fun String.toUniverse(): Universe {
            val grammar = object : Grammar<Universe>() {

                // tokens
                val newlineLit by literalToken("\n")
                val emptyLit by literalToken(".")
                val galaxyLit by literalToken("#")

                // parsers
                val empty by emptyLit use { Empty(BigInteger.ONE) }
                val galaxy by galaxyLit use { Galaxy }
                val pixel by empty or galaxy
                val pixels by oneOrMore(pixel)
                override val rootParser by separatedTerms(pixels, newlineLit) map { Universe(it) }
            }

            return grammar.parseToEnd(this)
        }
    }

    override val defaultInput = """.........................#...........................................................................................................#......
..................#................................................#........................#................#..............................
...........................................................................#........................#...........................#...........
........#...................#........#......#.............#.....................#...........................................................
..........................................................................................................#........#........................
.....................#..........................#..........................................................................#................
.#...........#................................................................................................#....................#......#.
...............................#..........................................#..........#......................................................
....................................#............................#...................................#......................................
.................#.......................................................................................................#..................
.........................#.....................#.......................#........#.....................................................#.....
.....#...............................................#......................................#...............................................
..............................#..................................................................#.............#............................
#....................................#..................................................................#...................................
..........................................................#.................................................................................
......................................................................#...........................................#.........................
............#...............................................................#............................................#.............#....
....#.........................................................................................................................#.............
...................................#.....#.................................................................................................#
................................................#........................#.........#..........................#.............................
..........................#....................................#................................#...........................................
......#..............#...........................................................................................................#..........
.................................#.......................#............................#................#....................................
..................................................#..................#.....#................................................................
............#..............................#.................................................#............................#.................
..................#...............................................................#........................#.....#....................#.....
.....#......................................................................................................................................
..............................................#............#.........................................#...............#......................
..................................................................#.........................................................................
............................#..............................................................................................#.............#..
......................#..........................................................................................................#..........
.......................................................................................#....................................................
.............................................#...............................#.............................#..........................#.....
.#................#.........................................................................................................................
................................#...................................................#..........................#............................
..........#..............#........................................#................................#.....................................#..
...............................................#.......#..................................#.................................................
............................................................#...................................................................#...........
....................#.....................#................................................................................#................
............................#.....................#............................................#............................................
.............#................................................................................................#.............................
.................................................................#......................#...............#...................................
.......................................................................#.........#..................................#.......................
......#.......................#........................#....................................................................................
...................#..................................................................................................................#.....
......................................#..............................................................#...................#..................
.#............................................#................#.............#.................#................#.............#.............
............................................................................................................................................
..................................................................................#..................................#......................
.......#..............#............................................#......#...............................#.............................#...
..................................#..............#..........................................................................................
..............#..........................................#..................................................................................
...............................................................#................................................#.................#.........
.........................#...................................................#.........................................#....................
............................................................................................................................................
...#..............#................................................................................#.......................#................
.....................................................#.................................#......#.............................................
.................................#.......................................#......#..................................#........................
............................................................................................................................................
............................................................................................................................................
....................................#............#...........................#.........................#....................#...............
......#................#.........................................................................#.........................................#
........................................#..................#................................................................................
.................#......................................................................#....................#.....#.................#......
.....................................................................................................#......................................
.#.......................................................................................................................#...............#..
..............................#.................#...........................................................................................
.......#...............#...................#.........................................#.....................#.....#..........................
...................................#...........................................................#............................................
..................#................................................#............#...........................................#......#........
............................................................................................................................................
.......................................................................................................................#....................
.............................#.....................#...........................................................#...........................#
...............#....................#.............................................................#.........................................
.....#..............#..................................................................................#....................................
#..............................................#...........................#................................................#...........#...
..................................................................#.............#..........#.......................................#........
............................................................................................................................................
.........#......#..........#........................#............................................................#..........................
........................................................................................#..........#........................................
........................................#...................#........#....................................#............#....................
..............................#..................................................#..........................................................
............................................#.........................................................#.....................................
.....#........#...........#..........................................................#......................................#...............
................................................#........................#.................................................................#
.....................................#.....................#..................................................#.................#.....#.....
.#.......#.........................................................#................................#.......................................
............................................................................................................................................
...............................#...........#................................................................................................
.................................................................................................#..........#.....#.........................
......#...........#........#.......................#..............................#.................................................#.......
.........................................................................#..................................................................
...........#..................................#........................................................................#.....#..............
.......................................#......................................................................#.............................
#.....................#.........................................................................#........................................#..
.................................................................................#...................#......................................
.................................................#..............#...........#......................................................#........
................#............#.....#........................................................................................................
.....#......................................#...............................................................................................
.......................................................#.....#.........................#.........#...................#......................
................................#....................................................................................................#......
.....................#.........................................................................................#............................
............#.......................................#...............#..........#....................#.......................................
.........................................................................................#..................................................
................................................#..............................................#.......................................#....
...#......................#...............................................................................................#......#..........
...........................................................#.................#.......#......................................................
..........................................................................................................#...........#.....................
......................................#........................#.....#.......................#................................#......#......
...................#..............................................................................#.........................................
.#..........................................................................................................................................
.......................#......#...........................................#.........#...........................#..........#................
.............#...................................#....................................................#...................................#.
...................................#........#...............................................................................................
................................................................................................#...................#.......................
.................................................................................................................................#..........
.....................#......................................#................#.......#......................................................
#......#..................#..............................................................................#..............#...................
...........................................#.....................................................................#..........................
.............#......................#...........#......................................................................................#....
...................#.....................................#............#.....................................................................
.......................................................................................#.........#.....#.............#......................
...........................................................................#....................................................#...........
..................................#.............................#..............................................#............................
...............#..........#......................#..................................#.......................................#...............
........................................#...................................................................................................
...........................................................................................#............#...................................
.............................#...............................................#........................................................#.....
.............#................................#......#.........#......#............................#............#...........................
...#.....................................................................................................................#..................
.........................................................#...........................#.....................................................#
........#........................................#..................................................................#..............#........
#..........................#......#.....#................................................#..................................................
............................................................................................................................................
....................................................#........#.................................#.......................#....................
.................#..........................................................................................................................
.......................#....................#........................#.....................#...........#..........#.........................
.....#..............................#.......................................................................#................#............#.
..........................................................#...............#.................................................................
...........#.......#.....................#...........#.........#.................#.................#........................................"""
}