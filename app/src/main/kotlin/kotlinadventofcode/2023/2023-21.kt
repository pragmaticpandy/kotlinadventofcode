// Originally generated by the template in CodeDAO
package kotlinadventofcode.`2023`

import com.github.h0tk3y.betterParse.combinators.*
import com.github.h0tk3y.betterParse.grammar.*
import com.github.h0tk3y.betterParse.lexer.*
import kotlinadventofcode.Day
import kotlinadventofcode.UI.UI
import kotlinadventofcode.util.isQuadratic
import kotlinadventofcode.util.quadratic

class `2023-21` : Day {
    override val year: Int = 2023
    override val day: Int = 21

    context(UI)
    override fun runPartOne(input: String): String {
        return input.toMap().getNumPositionsAfterSteps(64).toString()
    }

    context(UI)
    override fun runPartTwo(input: String): String {
        val map = input.toMap()
        show("width", map.width)
        show("height", map.height)
        show("start position", map.getStart())

        /**
         * The key insight is that the start is in the center and that its path is clear straight to
         * each edge. So, with the step count at (width/2), you won't leave the original grid.
         * With the step count at (width/2) + width, the end positions will exactly span a 3x3 grid
         * of grids, and so on.
         *
         * The results series that at each step adds a whole grid above, below, left, and right,
         * turns out to be quadratic.
         */
        val stepsToStayInOriginalGrid = map.width - map.getStart().x - 1

        val relation = (0..3)
            .map { stepsToStayInOriginalGrid + (map.width * it) }
            .map { it to shown("getting result for $it steps") { map.getNumPositionsAfterSteps(it) } }

        if (!relation.isQuadratic()) error ("expected relation to be quadratic")
        return "%.0f".format(relation.quadratic(26501365))
    }

    companion object {

        data class Grid(val tiles: List<List<Tile>>) {
            val width = tiles[0].size
            val height = tiles.size

            private data class GetResult(val normalizedCoord: Coord, val tile: Tile, val xOffset: Int, val yOffset: Int)
            private fun get(coord: Coord): GetResult {
                val normalizedCoord  = Coord((coord.x + width) % width, (coord.y + height) % height)
                val tile = tiles[normalizedCoord.y][normalizedCoord.x]
                val xOffset = if (coord.x < 0) -1 else if (coord.x >= width) 1 else 0
                val yOffset = if (coord.y < 0) -1 else if (coord.y >= height) 1 else 0
                return GetResult(normalizedCoord, tile, xOffset, yOffset)
            }

            fun getStart(): Coord {
                for (y in tiles.indices) {
                    for (x in tiles[y].indices) {
                        if (tiles[y][x] == Tile.START) return Coord(x, y)
                    }
                }

                error("no start found")
            }

            context(UI)
            fun getNumPositionsAfterSteps(steps: Int): Int {
                val result = getPositionsAfterSteps(steps, mutableMapOf(getStart() to setOf(Coord(0, 0))))
                return result.map { it.value.size }.sum()
            }

            context(UI)
            private tailrec fun getPositionsAfterSteps(steps: Int, positions: Map<Coord, Set<Coord>> ): Map<Coord, Set<Coord>> {
                show("num steps remaining", steps)
                if (steps == 0) return positions
                val result = mutableMapOf<Coord, MutableSet<Coord>>()
                positions.forEach { (coord, grids) ->
                    coord.adjacent.forEach { adjacent ->
                        result.getOrPut(adjacent.normalizedCoord) { mutableSetOf() }.addAll(grids.map { Coord(it.x + adjacent.xOffset, it.y + adjacent.yOffset) })
                    }
                }

                return getPositionsAfterSteps(steps - 1, result)
            }

            data class Coord(val x: Int, val y: Int)

            private val Coord.adjacent get() = listOf(Coord(x - 1, y), Coord(x + 1, y), Coord(x, y - 1), Coord(x, y + 1))
                .map { get(it)}
                .filter { it.tile != Tile.ROCKS }
        }

        enum class Tile {
            GARDEN, ROCKS, START;
        }

        fun String.toMap(): Grid {
            val grammar = object : Grammar<Grid>() {

                // tokens
                val gardenLit by literalToken(".")
                val rocksLit by literalToken("#")
                val startLit by literalToken("S")
                val newlineLit by literalToken("\n")

                // parsers
                val garden by gardenLit use { Tile.GARDEN }
                val rocks by rocksLit use { Tile.ROCKS }
                val start by startLit use { Tile.START }
                val tile by garden or rocks or start
                val row by oneOrMore(tile)
                override val rootParser by separatedTerms(row, newlineLit) map { Grid(it) }
            }

            return grammar.parseToEnd(this)
        }
    }

    override val defaultInput = """...................................................................................................................................
......#...........#................#......................................#.....#......#..##.#.......#....#.#........#...##...#....
...........#.................##...#...##......#............#...........##..#....................#.................#......#....#..#.
.....#.........#.....#.#.....###........###........#..........................##..##.......#.......#.....#...............#.......#.
....#..#......#......................#......#...............................#...........#........................#.............#...
.......#.....................#.............#......#...............#....................#............#.#.........#..#...............
.#.#.....#....#...................##......#..#..................#............................................#...............#.....
.....#....#...#....##...#......#.............#......##........#................#................#................#...............#.
.......#...................#..........#......................................#.........................##.........#..#.#..#........
....#..........#.........#....#......##...........##.................#................#...#............#...#..##....#...........#..
...#..........###............#.............#........................##..................#...##..................##......#...#......
.......#.......#.#..#.......#.......##..........#.........#..............................##.....#..#..........#.....#......#.......
..#.........#.....#..#..#..#..................#.........................#......................#.#..#...#..........#.....#....##.#.
..................................#.....#................#........#..........................#........#.....#...............#....#.
..........#..........#.#.................#.#.........................................#.......#..........#..##...#......#...........
.........#........#...........#...#.#....#.................##..#....................#..........#....#.#....##........#.......#.....
....#........#....................##..#......................#......#.........................#..#............................#....
...#.#...#...#......................#..#..........................#...#.#...............#......#.#........#....#..........#.....#..
..............#.....#.#......#........#...#..........#..#.#..#.........................#.....#..#......#.......#......#.......#....
.......................#.....#.....#................................##...#..#...#...........#..#..........#..#.#...#.........#...#.
.........#........#......#..#................................#.##.........#...#.................##......#.........#.##...#...#.....
.#.#.........##....#..........#..##.....................#..##...#..#..#...#.......#...........................#....................
.#.#......#..#..............##.#...#.#.............#.........#..............#.....#...............#..........................#...#.
.....##.....#.....##..#...#..#..#......................................#......#.............#.............#.....#......#........#..
......................#........#................#.......#..........#.............##............#..........#....#............#......
.....#..............................#.......##......#..#....#..............#.....................................#.....#.........#.
....................##...........#................#.#.....#.............#......#..##...#....................#................#.#...
.................................#...........#.....#..#..#..............#..##.........#..............#......#................#.....
............##.................................#..#...##.#........#...................................#...........#.#........#...#.
...#.......#.#........#......#...........#....#..#.......#....#........#.#.#.............##.......#.................#..............
...###............#......................##..##.........................#.........#......#..............#..#............#..........
..#.......#...##...#..#.......#.......#...#...........................................#...................#........##....#..#......
..#..................#.....#...........#.................#.#.#...........#..................#............#.......#.................
...##..#.............#.....#.....................#................#..........................#.............##...............#......
............#....#....#...#............#....#...........#.#.................#....#..................................#..............
...#.....#.............#...........................#.....##..........#...............#....#...............#........................
......#.....##.........#..........##..#...............#....#..#.#.#.....#.............#.###..............#..#......................
....................#...#...............#....................#...............#.#.#..##.............................#...............
...................#...#...........#...#.#...#...........#..............#............#..#......#............#.............#......#.
...#................#.................#.....#..........#........#.#........#...................#..#...........#.##........#......#.
....................#..........#....................#....#...#.....................#.......#.................#......#........#.....
...#.........#...................#.......##...###......#..#.......#.#..................#............#...........#....#...........#.
......#..#.#...#.#...............#.......................#.........#.......##................#...................#.###.............
...............#..............................................#.....#....#...#..#...#.....#......#.....#...........................
.......#.......#..........#.#.#..#.....#...#......#.................#........#...#..#.#.......#....................................
...........#..#.....................#.........................#...#.#.....#..........#....##.....#.................................
.......#.#.#.#..........#...#.##.##..#....................#.#.#..............#...................#....##...........................
.........................#.#.#...................#......#......#.............#.....#..............#......###..............#.#......
......#...............#...........#...................##..............#.##..#.#.#.#.#......#.....#.##.......#............#.#....##.
.....#....#.............#..##........###...#.......#.....#....#.......###....................#..#.#............................#...
.#........................#.....#......#.#.....................#......#.#...........#..#.....#.#.#..........#..............#...#...
.....##...#.........#.#.#.#...................#..#..#.#..#...#..#.....#.#.....#.........##.........................................
.................#.#...............#...............#...........#...........#.....#..........#...#.............................#....
.......................##...........#..........#...............#..#......................................#...#................#..#.
......#......................#..##.#........#.............#.....#..#....................#......#.........#.....#...#...........#.#.
.....................#.................#....##..#....#....##..#..............#..............#.....#...............#................
.#.................##.....#.#....#.....................#.............#....#......#...................#.#.##....................#...
.##..........##....#.##......#..#.................#...#..##........#....#..#.......#..............#.......#........................
......................#...........###.#.....##.............##........#..................#..............................#........#..
..#........................#...................#.#.#...#........#........#....#.....#.....#........................#...............
.#...........................#........#.....................#.....##.#..#.....#......#....#...#............##......................
............#...#..#..........#..............#...#...#..#..........#.........#...............#....#.#......#.#...#.................
..............................#..##...............#.....#....#.........................#....#...#....#.....#....#..................
..................#.#.........................#.......#........#.......#..##....#...#....#..................................#......
..........................#..#...#....................................#......#...#...#..#...#....#.............#.#.................
.................................................................S.................................................................
..............#...#...#.....##....#..................#....#........##..#.....#.#...#.#..............#.................##...........
.........##.........#............##.............................#.#...#.#.......#..........####....#...........#...........#.......
.........#...............................#...............#........................#......#..#......#.............##................
.............#..............................#...#.................#..........###.#.#.#.........#........#..........................
.#........#..#...........##...........#.#..........................#.........#....#.............#.............##...................
..#..........#..........................#...#..#..#.##...#..............#.....#...#............##........#.#.......#............#..
.................#.........#.......#.......#............#.#.................##...#.##.....................#.....#..................
.#.##..........#...#...................#...#.....##.....#...............#..#.........#..............#.................#............
.....#.......#..##....#..........#........#.#.....#.........#...............##......#.#....#.....#.................#...............
......#.......#.#...#....................#...............#.........#....#..#.#..........##.....#...#........................#......
.#.................#.................#.#....................#..............#.................#......#.......#.....#................
.#..#................................#......#..........#..............#.#.##.......................#...............................
..#.#............#.#......#...............#.#....#...#.#..#.......#...#.....#.......#........#.#...........#...#............##.....
.......#..........#....#....................#................##...........#......#..#...#....#...#......................#...#.#....
.........##........#........#......#.......#........#..#................#..#.............#..................#.#..........#.........
......#....#.................................#..#.#....#..............#........#.....#.##........#..........#.............#....#...
.............#........#.........#...##.....#.....#................##..........#.......#....#.......................................
..........................#.....#..#......#....#....#..##...#.......................#..............#.......#..........#..#......#..
...#.......................#....#.......#......#..................#................#...##........##.#............................#.
....#....................#.####..........#......#.....#......#....#.#.#................#...#..............#.............#.....#....
..........#..#...#..............##..#..#..#..........#.......#.##........##..............#.....#......#............#...#...........
..........................#..#..............#..#....#..#..............#.#...#..........#.....#..#.#................................
.......#.......#...............#.........#..#.#...#.....................#.....#......................#..............#.#..#.........
........#.....#.............#....................#.#........#.................#.....#...#..........#............#...............#..
.............#....##.........#.#................#....#.........#...#.......................#.....#.#..................#......#.....
...............#.....#.............#.....#.......#.......#......#.#..#.....#...#...#.......#................#...#................#.
...................#..#...........#..###....................#......#........#......#...........................#......#.......#....
..#.....#.##......#................#.................#.................##....................#.#...........#....#.#...#........#...
....#......#.#..#........#..............#.......#.........#.................#.............#.#...#...........#.#................#...
..#....#.#.......#...#.................#......#....#................#.......................#...#.........##..........#.........#..
..............#...............................#.##..............................#.......#..#...#...................#...#........#..
.#..#....#......#.....#...#............#..............................#..............#....................#..##..............#..##.
.......##............#..#............######............#................#..........#.#...#...#................#....................
...#..................##....................#.......#.#....##...................##..#....#..#..........#.....#.....................
...#.....#..#..#.#.......................#......................#...........#......###...#.............#........................#..
.....#.............#..........#......................#....#............#.##....#.......#.............#..........#........##........
........#...#.#..................#........#.#......#........#.....##...#...#....#...#......................................#.......
...............#............#..#.......................##.#.....#...#.#........#..................#......#.........................
.............##..#.......#.#.....#............#............#..........##.......#.....##...............................#...#........
.#..##...............#..............#...........#..#..#...##.......#..#.......................#.......##.....................#.#...
.....................###........#..#.....................#........#...#.##...................#....##.........#.........#...........
...#.....#...............#....#..###.......................................#..................#....................................
...#.#.#.....#..#.........#.....#...##.............#................#......#.....#........................#....#..............#....
...........#......#..##.......#......#..................#.....##..................#........#.......#......#...#...#..#...#.........
.........#.#.........#......#............................#.....#............#.................#..........#..............#.......#..
............#.........#.#....#.......#...................................#..............##.##..............#....#...............#..
.............#.....##.........#.........##...............#...............#.............................###........#.....#.#........
......##..........#....#.#.#..........##.#.#................#...#....##.......................#.......#...#.#........#.#..#........
....#....#............#.#......#..#.........#.............#.#..........................#.......#..............#..#..#.....#........
...................#...........#....#...#..#..#.......#..#...#.#........................#.................#.............#..........
.........#..#...#......#......#......#.................#...........#...................#........#.......#......#.#.......#.......#.
..#..#......#.....................#...........................#.....##................#.............................#..............
..#.#.......#........................#.......#..........................#................#.....#...#.........#.#......#............
...............................#....................................#.......................##....#......#.#.........#.#.........#.
.#.....................#......#..........#......#..............#...............##............#...#.##...#......##...#.#.#..........
...............#.#......#..................#......................................................#........................#.#.....
...#...#..#...............##...#...#.....#...#....................#..#..........#.....##......................................#....
.#..#...#........................#....#...##......#...........#.......................#...##......#.......#................#.......
....#...........#.............#.....#..#..#.....#.................................#........#.#..............#......................
....#....#........#..#.#..............#................................................#..............#................#.........#.
.....#..........#.......#..................#................................................#..............##...#..................
................#...............#..........#............##.........................#........#.#...............#...##...............
........#..................#..#.....#.#.........#.....#.#.#..................#.......#.#......#....#.........#..#.........#...#....
..#...........##...............#...........#..#...#...#.#..................##......#.....#.......#........#..#...#......#........#.
..................................................................................................................................."""
}